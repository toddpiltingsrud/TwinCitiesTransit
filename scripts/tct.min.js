var tct=tct||{};tct.BindingList=function(){this.list=[]};tct.BindingList.prototype={adjust:function(c){var b=0;for(c&&(b=Array.isArray(c)?c.length:c);this.list.length<b;)this.list.push({});for(;this.list.length>b&&0<this.list.length;)this.list.shift()},sync:function(c){var b,a,d=this;if(c){if(this.adjust(c.length),0<c.length)for(b=Object.getOwnPropertyNames(c[0]),a=0;a<c.length;a++)b.forEach(function(b){d.list[a][b]=c[a][b]})}else this.adjust(0)}};tct.common={getColor:function(c){c=Math.round(c/100*99);var b=99-c,a=[];a.push("#");10>b&&a.push("0");a.push(b);10>c&&a.push("0");a.push(c);a.push("00");return a.join("")},hasValue:function(c){return"undefined"!=typeof c&&null!==c},dateDiff:function(c,b){return Math.ceil(Math.abs(c-b)/1E3/60)},formatString:function(c,b){b=Array.isArray(b)?b:[b];for(var a=0,d="{"+a.toString()+"}";-1!=c.indexOf(d);)c=b.length>a?c.replace(new RegExp("\\{"+a.toString()+"\\}","g"),b[a].toString()):c.replace(new RegExp("\\{"+
a.toString()+"\\}","g"),""),a++,d="{"+a.toString()+"}";return c}};tct.Fave=function(c){var b=this;this.busStop=this.stopNumber=this.stop=this.direction=this.route=null;c&&(this.route=c.route,this.direction=c.direction,this.stop=c.stop,this.stopNumber=c.stopNumber,this.busStop=c.busStop);Object.defineProperty(this,"isValid",{get:function(){return tct.common.hasValue(b.route)&&tct.common.hasValue(b.direction)&&tct.common.hasValue(b.stop)||tct.common.hasValue(b.stopNumber)}});Object.defineProperty(this,"key",{get:function(){return b.isValid?b.getArgs().join("-"):null}});
    Object.defineProperty(this,"title",{get:function(){return 0==b.isValid?null:b.busStop?["Stop number "+b.busStop.id,b.busStop.desc]:tct.common.hasValue(b.stopNumber)?["Stop number "+b.stopNumber]:["Route "+b.route.Route+" - "+b.direction.Text,b.stop.Text]}})};tct.Fave.prototype={getArgs:function(){if(this.isValid)return this.stopNumber?[this.stopNumber]:[this.route.Route,this.direction.Value,this.stop.Value]}};
tct.Faves=function(c){this.dict={};this.svc=c;this.store=new Lawnchair({adapter:"dom",name:"transit"},function(c){});this.load()};
tct.Faves.prototype={isFave:function(c){return tct.common.hasValue(c)&&0==c.isValid?!1:this.dict.hasOwnProperty(c.key)},toggleFave:function(c){this.isFave(c)?this.remove(c):this.add(c)},getCurrent:function(){var c,b=this;this.store.get("current",function(a){a?c=new tct.Fave(a.value):(c=new tct.Fave,b.setCurrent(c))});return c},setCurrent:function(c){this.store.save({key:"current",value:c});this.isFave(c)&&this.add(c)},get:function(c){return this.dict[c]},add:function(c){this.dict[c.key]=c;this.save()},
    remove:function(c){delete this.dict[c.key];this.save()},load:function(){var c,b=this;this.store.get("nextripfaves",function(a){c=a?a.faves:{}});this.dict={};Object.getOwnPropertyNames(c).forEach(function(a){b.dict[a]=new tct.Fave(c[a])});return this.dict},save:function(){this.store.save({key:"nextripfaves",faves:this.dict})},getList:function(){var c=this,b=[];Object.getOwnPropertyNames(this.dict).forEach(function(a){b.push(c.dict[a])});return b},resolve:function(c,b){var a,d=this.get(c);if(d)return b&&
    b(d),d;var e=c.split("-");if(1==e.length)return d=new tct.Fave({stopNumber:e[0]}),b&&b(d),d;b&&(a=setTimeout(b,1E4),this.svc.getRouteDirectionStop(e[0],e[1],e[2],function(c){clearTimeout(a);d=new tct.Fave(c);b(d)}))}};tct.Gmap=function(c){this.map=null;this.circles=[];this.markers=[];this.buses=[];this.zoom=12;this.infoWindow=null;this.locationRequested=c};
tct.Gmap.prototype={createMap:function(c,b,a,d){this.map=new google.maps.Map(c,{center:{lat:b,lng:a},zoom:d||12});this.addLocateButton();return this},addLocateButton:function(){var c=document.createElement("div");c.className="locate-btn";this.map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(c);google.maps.event.addDomListener(c,"click",this.locationRequested)},addCircle:function(c,b){var a=new google.maps.LatLng(c,b),d={path:tct.svg.locate,fillColor:"#4285f4",fillOpacity:1,scale:.06,anchor:new google.maps.Point(920,
    920),strokeColor:"#ffffff",strokeWeight:2},a=new google.maps.Marker({position:a,icon:d,map:this.map});this.circles.push(a);return this},addMarker:function(c,b,a){c=new google.maps.LatLng(c,b);a=new google.maps.Marker({position:c,map:this.map,title:a});this.addMarkerClick(a);this.markers.push(a);return this},clearMarkers:function(){this.markers.forEach(function(c){c.setMap(null)});this.markers=[];return this},clearCircles:function(){this.circles.forEach(function(c){c.setMap(null)});this.circles=[];
    return this},addBus:function(c,b,a){var d={path:tct.svg.bus,fillColor:"#000000",fillOpacity:1,scale:.015,rotation:180,anchor:new google.maps.Point(700,700),strokeColor:"#222222",strokeWeight:.5};c=new google.maps.LatLng(c,b);a=new google.maps.Marker({position:c,icon:d,map:this.map,title:a});this.addMarkerClick(a);this.buses.push(a);return this},addMarkerClick:function(c){var b=this;google.maps.event.addListener(c,"click",function(){var a=c.getTitle();a&&(null!=b.infoWindow&&b.infoWindow.close(),b.infoWindow=
    new google.maps.InfoWindow({content:'<div class="info-window">'+a+"</div>"}),b.infoWindow.open(b.map,c))})},clearBuses:function(){this.buses.forEach(function(c){c.setMap(null)});this.buses=[];return this},clear:function(){this.clearBuses();this.clearCircles();this.clearMarkers();return this},center:function(c,b){this.map.panTo({lat:c,lng:b});this.clearCircles();this.addCircle(c,b);return this}};tct.transit=angular.module("transit",["ngRoute"]);
(function(c,b){b.config(["$routeProvider",function(a){a.when("/faves",{templateUrl:"partials/faves.html",controller:"faves"}).when("/track",{templateUrl:"partials/track.html",controller:"track"}).when("/stop",{templateUrl:"partials/stop.html",controller:"stop"}).when("/map",{templateUrl:"partials/map.html",controller:"map"}).when("/about",{templateUrl:"partials/about.html",controller:"common"}).when("/acerca",{templateUrl:"partials/acerca.html"}).otherwise({templateUrl:"partials/home.html",controller:"home"})}]);
    b.factory("svc",function(){return tct.ws});b.service("busStops",["$http",function(a){var c=function(){var c=this;this.stops=null;this.queue=[];a.get("scripts/stops.js").success(function(a){for(c.stops=a;0<c.queue.length;)a=c.queue.shift(),a.func.apply(c,a.args)}).error(function(){})};c.prototype={enQueue:function(a,c){this.queue.push({func:a,args:c})},midpoint:function(a,c){return Math.round(a+(c-a)/2)},binarySearch:function(a,c,b){b=b||0;for(var d=0,k=c.length-1,h=0;k>=d;){h=this.midpoint(d,k);if(c[h][b]==
        a)return c[h];c[h][b]<a?d=h+1:k=h-1}return null},getStop:function(a,c){if(null===this.stops)this.enQueue(this.getStop,[a,c]),c(null);else{var b=this.binarySearch(a,this.stops);null!==b?c({id:b[0],desc:b[1],lat:b[2],lng:b[3]}):c(null)}},closestStops:function(a,c,b){if(null===this.stops)this.enQueue(this.closestStops,[a,c,b]),b(null);else{var d=gryst.from(this.stops,"s").orderBy("s",function(b,d){var g=Math.abs(b[2]-a)+Math.abs(b[3]-c),l=Math.abs(d[2]-a)+Math.abs(d[3]-c);return g-l}).take(20).select(function(a){return{id:a[0],
        desc:a[1],lat:a[2],lng:a[3]}}).run();b(d)}}};return new c}]);b.factory("faves",["svc",function(a){return new tct.Faves(a)}]);b.service("timer",["$rootScope",function(a){return new function(){var c,b=this,f=new Date;this.millis=3E4;this.percent=100;this.interval=b.millis/100;this.start=function(){b.interval=b.millis/100;f=new Date;c=setInterval(g,b.interval)};this.stop=function(){clearInterval(c)};Object.defineProperty(this,"time",{get:function(){return new Date-f}});var g=function(){b.percent=100-
    Math.round(b.time/b.millis*100);0>=b.percent&&(f=new Date,b.percent=100,a.$broadcast("timerBuzz",b));a.$broadcast("timerTick",b)}}}]);b.factory("geoLocate",["$rootScope",function(a){return new function(){var b=this,e=new Lawnchair({adapter:"dom",name:"transit"},function(a){});this.locationChanged="geoLocate_LocationChanged";this["default"]={lat:44.9833,lng:-93.2667};this.geoLocation=!0;this.getCurrent=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(c){a.$broadcast(b.locationChanged,
        {lat:c.coords.latitude,lng:c.coords.longitude});b.setLast(c.coords.latitude,c.coords.longitude)},function(){a.$broadcast(b.locationChanged,null)}):(b.geoLocation=!1,a.$broadcast(b.locationChanged,null))};this.getLast=function(a){e.get("lastLocation",function(c){c&&c.value?a(c.value):a(b["default"])})};this.setLast=function(a,c){e.save({key:"lastLocation",value:{lat:a,lng:c}})};this.getLast(function(e){null!==e&&c.hasValue(e.lat)&&c.hasValue(e.lng)&&(b["default"]=e,a.$broadcast(b.locationChanged,e))})}}]);
    b.factory("lang",function(){var a=new Lawnchair({adapter:"dom",name:"transit"},function(a){}),c={current:{},English:{name:"English",alternate:"Espa\u00f1ol",about:"About",aboutRoute:"about",home:"Home",favorites:"Favorites",selectRoute:"Select a route...",selectDirection:"Select a direction...",selectStop:"Select a stop...",enterStopNumber:"Enter stop number...",stopNumber:"Stop number",route:"Route",northBound:"NORTHBOUND",southBound:"SOUTHBOUND",westBound:"WESTBOUND",eastBound:"EASTBOUND",map:"Map",
        findMe:"Find me"},Spanish:{name:"Espa\u00f1ol",alternate:"English",about:"Acerca",aboutRoute:"acerca",home:"Portada",favorites:"Favoritos",selectRoute:"Seleccione una ruta...",selectDirection:"Seleccione una direcci\u00f3n...",selectStop:"Seleccione una parada...",enterStopNumber:"Introduzca n\u00famero de parada...",stopNumber:"Parada",route:"Ruta",northBound:"Norte",southBound:"Sur",westBound:"Oeste",eastBound:"Este",map:"Mapa",findMe:"Encontrarme"},setCurrent:function(c){var b=this,d=this[c];Object.getOwnPropertyNames(d).forEach(function(a){b.current[a]=
        d[a]});a.save({key:"currentLanguage",value:c})}};a.get("currentLanguage",function(a){a?c.setCurrent(a.value):c.setCurrent("English")});return c});b.filter("tct_translate",["lang",function(a){var c=[],b=[];Object.getOwnPropertyNames(a.English).forEach(function(f){c.push(a.English[f]);b.push(a.current[f])});return function(f){if("English"==a.current.name)return f;var g;for(g=0;g<c.length;g++)f=f.replace(c[g],b[g]);return f}}]);b.controller("home",["$scope","faves","$location","svc","lang","busStops",
        function(a,c,b,f,g,l){a.model=new tct.Fave;a.routes=[];a.directions=[];a.stops=[];a.lang=g.current;f.getRoutes(function(c){a.$apply(function(){a.routes=c})});a.$watch("model.route",function(){a.model.route&&(a.stops=[],a.model.direction=null,a.model.stop=null,f.getDirections(a.model.route.Route,function(c){a.$apply(function(){a.directions=c})}))});a.$watch("model.direction",function(){a.model.direction&&(a.stops=[],a.model.stop=null,f.getStops(a.model.route.Route,a.model.direction.Value,function(c){a.$apply(function(){a.stops=
            c})}))});a.$watch("model.stop",function(){a.model.stop&&(c.setCurrent(a.model),b.path("/track"))});a.trackStopNumber=function(){a.model.stopNumber&&(a.model.route=null,a.model.direction=null,a.model.stop=null,c.setCurrent(a.model),b.path("/stop"))}}]);b.controller("common",["$scope","lang",function(a,c){a.lang=c.current}]);b.controller("track",["$scope","faves","$location","svc","timer","lang",function(a,b,e,f,g,l){var k=new tct.BindingList,h,n,m=e.search();a.lang=l;a.faves=b;a.departures=k.list;
        var p=function(){h=a.model.getArgs();f.getDepartures(h,function(b){n=new Date;b=b.slice(0,8);a.$apply(function(){k.adjust(b)});b.forEach(function(a){a.Minutes=c.dateDiff(a.DepartureTime,n);a.Percent=a.Minutes/60*100;a.Percent=100<a.Percent?100:a.Percent});k.sync(b)})},q=function(){0==a.model.isValid?e.path("/home"):(g.start(),p(),a.$on("timerBuzz",p),a.$on("$destroy",g.stop))};c.hasValue(m)&&c.hasValue(m.key)?b.resolve(m.key,function(c){a.model=c;b.setCurrent(c);q()}):(a.model=b.getCurrent(),q())}]);
    b.controller("stop",["$scope","faves","$location","svc","timer","lang","busStops",function(a,b,e,f,g,l,k){a.faves=b;a.lang=l.current;var h;l=e.search().key;var n={},m=function(){var b=a.model.getArgs();f.getDepartures(b,function(b){var d=gryst.from(b,"a").orderBy("a.Route").thenBy("a.DepartureTime").group("a",function(a){return a.Route+a.RouteDirection},"a").select(function(a){0==n.hasOwnProperty(a.key)&&(n[a.key]=new tct.BindingList);n[a.key].sync(a.values.slice(0,8));return n[a.key].list}).run();
        a.$apply(function(){a.departures=d});var e=new Date;d.forEach(function(a){a.forEach(function(a){a.Minutes=c.dateDiff(a.DepartureTime,e);a.Percent=a.Minutes/60*100;a.Percent=100<a.Percent?100:a.Percent})})})},p=function(){a.model=h;a.getColor=c.getColor;0==a.model.isValid?e.path("/home"):(g.start(),m(),a.$on("timerBuzz",m),a.$on("$destroy",g.stop))};h=l?b.resolve(l):b.getCurrent();c.hasValue(h.stopNumber)&&0==c.hasValue(h.busStop)?(console.log(k),k.getStop(h.stopNumber,function(a){h.busStop=a;b.setCurrent(h);
        p()})):p()}]);b.controller("map",["$scope","lang","svc","$location","timer","faves","geoLocate","busStops",function(a,b,e,f,g,l,k,h){a.lang=b.current;var n;f=f.search();var m=new tct.Gmap(k.getCurrent),p=document.getElementById("map-canvas"),q=function(){a.model.busStop?(a.title=b.current.stopNumber+" "+a.model.busStop.id+" "+a.model.busStop.desc,m.createMap(p,a.model.busStop.lat,a.model.busStop.lng),m.addMarker(a.model.busStop.lat,a.model.busStop.lng,c.formatString("{0} {1} {2}",[b.current.stopNumber,
        a.model.busStop.id,a.model.busStop.desc]))):(a.title=b.current.route+" "+a.model.route.Route,m.createMap(p,k["default"].lat,k["default"].lng,13));m.addCircle(k["default"].lat,k["default"].lng);n=a.model.stopNumber?function(){m.clearBuses();e.getDepartures([a.model.stopNumber],function(a){a.forEach(function(a){var b=c.formatString("{0} {1} {2} - {3}",[a.Route,a.Terminal,a.RouteDirection,a.Description]);m.addBus(a.VehicleLatitude,a.VehicleLongitude,b)})})}:function(){m.clearBuses();e.getVehicleLocations(a.model.route.Route,
        function(a){a.forEach(function(a){m.addBus(a.VehicleLatitude,a.VehicleLongitude,a.Route+a.Terminal+" "+a.RouteDirection)})})};n();g.start();a.$on(k.locationChanged,function(a,b){m.center(b.lat,b.lng)});a.$on("timerBuzz",n);a.$on("$destroy",g.stop)};f&&f.key?l.resolve(f.key,function(b){a.model=b;l.setCurrent(b);c.hasValue(b.stopNumber)&&!c.hasValue(b.busStop)?h.getStop(b.stopNumber,function(a){null!==a&&(b.busStop=a,l.setCurrent(b));q()}):q()}):(a.model=l.getCurrent(),q())}]);b.controller("faves",
        ["$scope","faves","lang",function(a,b,c){a.lang=c.current;a.model=b;a.list=b.getList();a.list.forEach(function(a){a.path=a.stopNumber?"stop":"track"})}])})(tct.common,tct.transit);
(function(c){c.directive("tctClock",function(){return{restrict:"E",templateUrl:"partials/clock.html",link:function(b,a){function c(){var a,b=new Date,d=b.getHours();a=12>d?0:1;0==d?d=12:12<d&&(d-=12);var f=Math.floor(d/10),d=d-10*f,m=Math.floor(b.getMinutes()/10),p=b.getMinutes()-10*m,q=Math.floor(b.getSeconds()/10),b=b.getSeconds()-10*q;e(g[1],f,2);e(g[2],d,10);e(g[4],m,6);e(g[5],p,10);e(g[7],q,6);e(g[8],b,10);e(g[9],a,2)}function e(a,b,c){var d=a.currentDigit;0==b&&(b=c);if("undefined"===typeof d||
    d!=b)a.currentDigit=b,b="pos-"+b,$(a).addClass(b),a.posClass&&$(a).removeClass(a.posClass),a.posClass=b,a.currentDigit==c&&setTimeout(function(){$(a).removeClass(a.posClass)},600)}var f,g=a.find("div");c();f=setInterval(c,1E3);a.on("$destroy",function(){clearInterval(f)})}}});c.directive("tctTracker",["faves",function(b){return{restrict:"E",templateUrl:"partials/tracker.html",link:function(a){a.faves=b;a.getColor=tct.common.getColor}}}]);c.directive("tctCountdown",["timer",function(b){return{restrict:"E",
    templateUrl:"partials/countdown.html",link:function(a,c){c.find("img");a.percent=100;a.interval=b.interval/1E3;a.$on("timerTick",function(){a.$apply(function(){a.percent=b.percent})})}}}]);c.directive("tctLanguage",["lang","$route",function(b,a){return{restrict:"A",link:function(c,e){$(e).click(function(){b.setCurrent("English"==b.current.name?"Spanish":"English");a.reload()})}}}])})(tct.transit);tct.svg={bus:"M285 1542 c-37 -23 -93 -86 -106 -119 -5 -13 -9 -168 -9 -344 l0 -319 -40 0 -40 0 0 100 c0 93 1 100 20 100 19 0 20 7 20 195 l0 195 -55 0 -55 0 0 -195 0 -195 25 0 25 0 0 -110 0 -110 44 0 c37 0 45 -4 50 -22 3 -13 6 -122 6 -243 0 -248 6 -273 73 -332 33 -29 37 -37 37 -83 l0 -50 95 0 95 0 0 40 0 40 275 0 275 0 0 -40 0 -40 95 0 95 0 0 48 c0 43 4 52 41 87 75 72 79 89 79 352 l0 232 53 3 52 3 3 98 c2 89 4 97 22 97 19 0 20 8 20 195 l0 195 -50 0 -50 0 0 -195 c0 -188 1 -195 20 -195 19 0 20 -7 20 -90 l0 -90 -45 0 -45 0 0 323 c0 292 -2 326 -19 362 -22 47 -74 99 -114 114 -18 7 -178 11 -455 11 -396 0 -429 -1 -457 -18z m725 -82 l0 -60 -257 2 -258 3 -3 58 -3 57 261 0 260 0 0 -60z m230 -373 l0 -253 -38 -36 c-41 -40 -116 -77 -202 -99 -76 -19 -434 -19 -510 0 -86 22 -161 59 -202 99 l-38 36 0 253 0 253 495 0 495 0 0 -253z m-20 -562 l0 -55 -475 0 -475 0 0 55 0 55 475 0 475 0 0 -55z m0 -190 l0 -55 -475 0 -475 0 0 55 0 55 475 0 475 0 0 -55z",
    locate:"M858 994 c-30 -16 -58 -61 -58 -94 0 -29 26 -76 52 -94 12 -9 40 -16 61 -16 55 0 107 52 107 107 0 85 -88 138 -162 97z"};(function(c){tct.ws={v:Math.round((new Date).getTime()/1E3/60)-23708152,url:"http://svc.metrotransit.org/NexTrip/{0}?v={1}&format=json&callback={2}",directions:["","SOUTHBOUND","EASTBOUND","WESTBOUND","NORTHBOUND"],getJSON:function(b){var a=document.createElement("script");a.type="text/javascript";a.src=b;document.body.appendChild(a)},getRoutes:function(b){this.getRoutesCB=b;b=c.formatString(this.url,["Routes",this.v++,"tct.ws.getRoutesCB"]);this.getJSON(b)},getRoutesCB:null,getDirections:function(b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         a){this.getDirectionsCB=a;var d=c.formatString(this.url,["Directions/"+b,this.v++,"tct.ws.getDirectionsCB"]);this.getJSON(d)},getDirectionsCB:null,getStops:function(b,a,d){this.getStopsCB=d;b=c.formatString(this.url,["Stops/"+b+"/"+a,this.v++,"tct.ws.getStopsCB"]);this.getJSON(b)},getStopsCB:null,getDepartures:function(b,a){this.getDeparturesCB2=a;var d=c.formatString(this.url,[b.join("/"),this.v++,"tct.ws.getDeparturesCB"]);this.getJSON(d)},getDeparturesCB:function(b){this.convertDates(b);this.getDeparturesCB2(b)},
    getDeparturesCB2:null,getVehicleLocations:function(b,a){this.getVehicleLocationsCB2=a;var d=c.formatString(this.url,["VehicleLocations/"+b,this.v++,"tct.ws.getVehicleLocationsCB"]);this.getJSON(d)},getVehicleLocationsCB:function(b){b.forEach(function(a){a.RouteDirection=tct.ws.directions[a.Direction]});this.convertDates(b,"LocationTime");this.getVehicleLocationsCB2(b)},getVehicleLocationsCB2:null,getRouteDirectionStop:function(b,a,c,e){function f(){g&&h&&l&&(clearTimeout(k),e({route:g,direction:h,
        stop:l}))}var g,l,k,h={Text:this.directions[a],Value:a.toString()};this.getRoutes(function(a){var c;for(c=0;c<a.length;c++)if(a[c].Route==b){g=a[c];f();return}g={Route:b};f()});this.getStops(b,a,function(a){var b;for(b=0;b<a.length;b++)if(a[b].Value==c){l=a[b];f();return}l={Value:c};f()});k=setTimeout(e,1E4)},convertDates:function(b,a){a=a||"DepartureTime";var c,e=/\d+/;b.forEach(function(b){c=parseInt(b[a].match(e));b[a]=new Date(c)})}}})(tct.common);
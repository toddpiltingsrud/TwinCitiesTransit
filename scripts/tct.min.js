var tct={};tct.BindingList=function(){this.list=[]},tct.BindingList.prototype={adjust:function(a){var b=0;for(a&&(b=Array.isArray(a)?a.length:a);this.list.length<b;)this.list.push({});for(;this.list.length>b&&this.list.length>0;)this.list.shift()},sync:function(a){var b,c,d=this;if(a){if(this.adjust(a.length),a.length>0)for(b=Object.getOwnPropertyNames(a[0]),c=0;c<a.length;c++)b.forEach(function(b){d.list[c][b]=a[c][b]})}else this.adjust(0)}},tct.common={getColor:function(a){var b=Math.round(99*(a/100)),c=99-b,d=[];return d.push("#"),10>c&&d.push("0"),d.push(c),10>b&&d.push("0"),d.push(b),d.push("00"),d.join("")},hasValue:function(a){return"undefined"!=typeof a&&null!==a},dateDiff:function(a,b){return Math.ceil(Math.abs(a-b)/1e3/60)},formatString:function(a,b){b=Array.isArray(b)?b:[b];for(var c=0,d="{"+c.toString()+"}";-1!=a.indexOf(d);)a=b.length>c?a.replace(new RegExp("\\{"+c.toString()+"\\}","g"),b[c].toString()):a.replace(new RegExp("\\{"+c.toString()+"\\}","g"),""),c++,d="{"+c.toString()+"}";return a}},tct.Fave=function(a){var b=this;this.route=null,this.direction=null,this.stop=null,this.stopNumber=null,this.busStop=null,a&&(this.route=a.route,this.direction=a.direction,this.stop=a.stop,this.stopNumber=a.stopNumber,this.busStop=a.busStop),Object.defineProperty(this,"isValid",{get:function(){return tct.common.hasValue(b.route)&&tct.common.hasValue(b.direction)&&tct.common.hasValue(b.stop)||tct.common.hasValue(b.stopNumber)}}),Object.defineProperty(this,"key",{get:function(){return b.isValid?b.getArgs().join("-"):null}}),Object.defineProperty(this,"title",{get:function(){return 0==b.isValid?null:b.busStop?["Stop number "+b.busStop.id,b.busStop.desc]:tct.common.hasValue(b.stopNumber)?["Stop number "+b.stopNumber]:["Route "+b.route.Route+" - "+b.direction.Text,b.stop.Text]}})},tct.Fave.prototype={getArgs:function(){return this.isValid?this.stopNumber?[this.stopNumber]:[this.route.Route,this.direction.Value,this.stop.Value]:void 0}},tct.Faves=function(a){this.dict={},this.svc=a,this.store=new Lawnchair({adapter:"dom",name:"transit"},function(){}),this.load()},tct.Faves.prototype={isFave:function(a){return tct.common.hasValue(a)&&0==a.isValid?!1:this.dict.hasOwnProperty(a.key)},toggleFave:function(a){this.isFave(a)?this.remove(a):this.add(a)},getCurrent:function(){var a,b=this;return this.store.get("current",function(c){c?a=new tct.Fave(c.value):(a=new tct.Fave,b.setCurrent(a))}),a},setCurrent:function(a){this.store.save({key:"current",value:a}),this.isFave(a)&&this.add(a)},get:function(a){return this.dict[a]},add:function(a){this.dict[a.key]=a,this.save()},remove:function(a){delete this.dict[a.key],this.save()},load:function(){var a,b,c=this;return this.store.get("nextripfaves",function(b){a=b?b.faves:{}}),this.dict={},b=Object.getOwnPropertyNames(a),b.forEach(function(b){c.dict[b]=new tct.Fave(a[b])}),this.dict},save:function(){var a=this;this.store.save({key:"nextripfaves",faves:a.dict})},getList:function(){var a=this,b=[],c=Object.getOwnPropertyNames(this.dict);return c.forEach(function(c){b.push(a.dict[c])}),b},resolve:function(a,b){var c,d=this.get(a);if(d)return b&&b(d),d;var e=a.split("-");return 1==e.length?(d=new tct.Fave({stopNumber:e[0]}),b&&b(d),d):(b&&(c=setTimeout(b,1e4),this.svc.getRouteDirectionStop(e[0],e[1],e[2],function(a){clearTimeout(c),d=new tct.Fave(a),b(d)})),void 0)}},tct.Gmap=function(a){this.map=null,this.circles=[],this.markers=[],this.buses=[],this.zoom=12,this.infoWindow=null,this.locationRequested=a},tct.Gmap.prototype={createMap:function(a,b,c,d){return d=d||12,this.map=new google.maps.Map(a,{center:{lat:b,lng:c},zoom:d}),this.addLocateButton(),this},addLocateButton:function(){var a=document.createElement("div");a.className="locate-btn",this.map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(a),google.maps.event.addDomListener(a,"click",this.locationRequested)},addCircle:function(a,b){var c=new google.maps.LatLng(a,b),d={path:tct.svg.locate,fillColor:"#4285f4",fillOpacity:1,scale:.06,anchor:new google.maps.Point(920,920),strokeColor:"#ffffff",strokeWeight:2},e=new google.maps.Marker({position:c,icon:d,map:this.map});return this.circles.push(e),this},addMarker:function(a,b,c){var d=this,e=new google.maps.LatLng(a,b),f=new google.maps.Marker({position:e,map:d.map,title:c});return this.markers.push(f),this},clearMarkers:function(){return this.markers.forEach(function(a){a.setMap(null)}),this.markers=[],this},clearCircles:function(){return this.circles.forEach(function(a){a.setMap(null)}),this.circles=[],this},addBus:function(a,b,c){var d=this,e={path:tct.svg.bus,fillColor:"#000000",fillOpacity:1,scale:.015,rotation:180,anchor:new google.maps.Point(700,700),strokeColor:"#222222",strokeWeight:.5},f=new google.maps.LatLng(a,b),g=new google.maps.Marker({position:f,icon:e,map:this.map,title:c});return google.maps.event.addListener(g,"click",function(){var a=g.getTitle();a&&(null!=d.infoWindow&&d.infoWindow.close(),d.infoWindow=new google.maps.InfoWindow({content:'<div class="info-window">'+a+"</div>"}),d.infoWindow.open(d.map,g))}),this.buses.push(g),this},clearBuses:function(){return this.buses.forEach(function(a){a.setMap(null)}),this.buses=[],this},clear:function(){return this.clearBuses(),this.clearCircles(),this.clearMarkers(),this},center:function(a,b){return this.map.panTo({lat:a,lng:b}),this.clearCircles(),this.addCircle(a,b),this}};var transit=angular.module("transit",["ngRoute"]);!function(a,b){b.config(["$routeProvider",function(a){a.when("/faves",{templateUrl:"partials/faves.html",controller:"faves"}).when("/track",{templateUrl:"partials/track.html",controller:"track"}).when("/stop",{templateUrl:"partials/stop.html",controller:"stop"}).when("/map",{templateUrl:"partials/map.html",controller:"map"}).when("/about",{templateUrl:"partials/about.html",controller:"common"}).when("/acerca",{templateUrl:"partials/acerca.html"}).otherwise({templateUrl:"partials/home.html",controller:"home"})}]),b.factory("svc",function(){return tct.ws}),b.service("busStops",["$http",function(a){var b=function(){var b=this;this.stops=null,this.queue=[];var c=function(){for(var a;b.queue.length>0;)a=b.queue.shift(),a.func.apply(b,a.args)};a.get("scripts/stops.js").success(function(a){b.stops=a,c()}).error(function(){})};return b.prototype={enQueue:function(a,b){var c={func:a,args:b};this.queue.push(c)},midpoint:function(a,b){return Math.round(a+(b-a)/2)},binarySearch:function(a,b,c){c=c||0;for(var d=0,e=b.length-1,f=0;e>=d;){if(f=this.midpoint(d,e),b[f][c]==a)return b[f];b[f][c]<a?d=f+1:e=f-1}return null},getStop:function(a,b){if(null===this.stops)return this.enQueue(this.getStop,[a,b]),b(null),void 0;var c=this.binarySearch(a,this.stops);null!==c?b({id:c[0],desc:c[1],lat:c[2],lng:c[3]}):b(null)},closestStops:function(a,b,c){if(null===this.stops)return this.enQueue(this.closestStops,[a,b,c]),c(null),void 0;var d=gryst.from(this.stops,"s").orderBy("s",function(c,d){var e=Math.abs(c[2]-a)+Math.abs(c[3]-b),f=Math.abs(d[2]-a)+Math.abs(d[3]-b);return e-f}).take(20).select(function(a){return{id:a[0],desc:a[1],lat:a[2],lng:a[3]}}).run();c(d)}},new b}]),b.factory("faves",["svc",function(a){return new tct.Faves(a)}]),b.service("timer",["$rootScope",function(a){var b=function(){var b,c=this,d=new Date;this.millis=3e4,this.percent=100,this.interval=c.millis/100,this.start=function(){c.interval=c.millis/100,d=new Date,b=setInterval(e,c.interval)},this.stop=function(){clearInterval(b)},Object.defineProperty(this,"time",{get:function(){var a=new Date;return a-d}});var e=function(){c.percent=100-Math.round(100*(c.time/c.millis)),c.percent<=0&&(d=new Date,c.percent=100,a.$broadcast("timerBuzz",c)),a.$broadcast("timerTick",c)}};return new b}]),b.factory("geoLocate",function(){var b=function(){var b=this,c="lastLocation",d=new Lawnchair({adapter:"dom",name:"transit"},function(){});this.default={lat:44.9833,lng:-93.2667},this.geoLocation=!0,this.getCurrent=function(a){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(c){a({lat:c.coords.latitude,lng:c.coords.longitude}),b.setLast(c.latitude,c.longitude)},function(){a(null)}):(b.geoLocation=!1,a(null))},this.getLast=function(a){d.get(c,function(b){b&&b.value?a(b.value):a(null)})},this.setLast=function(a,b){var e={lat:a,lng:b};d.save({key:c,value:e})},this.getLast(function(c){null!==c&&a.hasValue(c.lat)&&a.hasValue(c.lng)&&(b.default=c)})};return new b}),b.factory("lang",function(){var a=new Lawnchair({adapter:"dom",name:"transit"},function(){}),b={current:{},English:{name:"English",alternate:"Espa\xf1ol",about:"About",aboutRoute:"about",home:"Home",favorites:"Favorites",selectRoute:"Select a route...",selectDirection:"Select a direction...",selectStop:"Select a stop...",enterStopNumber:"Enter stop number...",stopNumber:"Stop number",route:"Route",northBound:"NORTHBOUND",southBound:"SOUTHBOUND",westBound:"WESTBOUND",eastBound:"EASTBOUND",map:"Map",findMe:"Find me"},Spanish:{name:"Espa\xf1ol",alternate:"English",about:"Acerca",aboutRoute:"acerca",home:"Portada",favorites:"Favoritos",selectRoute:"Seleccione una ruta...",selectDirection:"Seleccione una direcci\xf3n...",selectStop:"Seleccione una parada...",enterStopNumber:"Introduzca n\xfamero de parada...",stopNumber:"Parada",route:"Ruta",northBound:"Norte",southBound:"Sur",westBound:"Oeste",eastBound:"Este",map:"Mapa",findMe:"Encontrarme"},setCurrent:function(b){var c=this,d=this[b],e=Object.getOwnPropertyNames(d);e.forEach(function(a){c.current[a]=d[a]}),a.save({key:"currentLanguage",value:b})}};return a.get("currentLanguage",function(a){a?b.setCurrent(a.value):b.setCurrent("English")}),b}),b.filter("tct_translate",["lang",function(a){var b=Object.getOwnPropertyNames(a.English),c=[],d=[];return b.forEach(function(b){c.push(a.English[b]),d.push(a.current[b])}),function(b){if("English"==a.current.name)return b;var e;for(e=0;e<c.length;e++)b=b.replace(c[e],d[e]);return b}}]),b.controller("home",["$scope","faves","$location","svc","lang","busStops",function(a,b,c,d,e){a.model=new tct.Fave,a.routes=[],a.directions=[],a.stops=[],a.lang=e.current,d.getRoutes(function(b){a.$apply(function(){a.routes=b})}),a.$watch("model.route",function(){a.model.route&&(a.stops=[],a.model.direction=null,a.model.stop=null,d.getDirections(a.model.route.Route,function(b){a.$apply(function(){a.directions=b})}))}),a.$watch("model.direction",function(){a.model.direction&&(a.stops=[],a.model.stop=null,d.getStops(a.model.route.Route,a.model.direction.Value,function(b){a.$apply(function(){a.stops=b})}))}),a.$watch("model.stop",function(){a.model.stop&&(b.setCurrent(a.model),c.path("/track"))}),a.trackStopNumber=function(){a.model.stopNumber&&(a.model.route=null,a.model.direction=null,a.model.stop=null,b.setCurrent(a.model),c.path("/stop"))}}]),b.controller("common",["$scope","lang",function(a,b){a.lang=b.current}]),b.controller("track",["$scope","faves","$location","svc","timer","lang",function(b,c,d,e,f,g){var i,j,h=new tct.BindingList,k=d.search();b.lang=g,b.faves=c,b.departures=h.list;var l=function(){i=b.model.getArgs(),e.getDepartures(i,function(c){j=new Date,c=c.slice(0,8),b.$apply(function(){h.adjust(c)}),c.forEach(function(b){b.Minutes=a.dateDiff(b.DepartureTime,j),b.Percent=100*(b.Minutes/60),b.Percent=b.Percent>100?100:b.Percent}),h.sync(c)})},m=function(){return 0==b.model.isValid?(d.path("/home"),void 0):(f.start(),l(),b.$on("timerBuzz",l),b.$on("$destroy",f.stop),void 0)};a.hasValue(k)&&a.hasValue(k.key)?c.resolve(k.key,function(a){b.model=a,c.setCurrent(a),m()}):(b.model=c.getCurrent(),m())}]),b.controller("stop",["$scope","faves","$location","svc","timer","lang","busStops",function(b,c,d,e,f,g,h){b.faves=c,b.lang=g.current;var i,j=d.search(),k=j.key,l={},m=function(){var c=b.model.getArgs();e.getDepartures(c,function(c){var d=gryst.from(c,"a").orderBy("a.Route").thenBy("a.DepartureTime").group("a",function(a){return a.Route+a.RouteDirection},"a").select(function(a){return 0==l.hasOwnProperty(a.key)&&(l[a.key]=new tct.BindingList),l[a.key].sync(a.values.slice(0,8)),l[a.key].list}).run();b.$apply(function(){b.departures=d});var e=new Date;d.forEach(function(b){b.forEach(function(b){b.Minutes=a.dateDiff(b.DepartureTime,e),b.Percent=100*(b.Minutes/60),b.Percent=b.Percent>100?100:b.Percent})})})},n=function(){return b.model=i,b.getColor=a.getColor,0==b.model.isValid?(d.path("/home"),void 0):(f.start(),m(),b.$on("timerBuzz",m),b.$on("$destroy",f.stop),void 0)};i=k?c.resolve(k):c.getCurrent(),a.hasValue(i.stopNumber)&&0==a.hasValue(i.busStop)?(console.log(h),h.getStop(i.stopNumber,function(a){i.busStop=a,c.setCurrent(i),n()})):n()}]),b.controller("map",["$scope","lang","svc","$location","timer","faves","geoLocate","busStops",function(b,c,d,e,f,g,h,i){b.lang=c.current;var j,l=e.search(),m=new tct.Gmap(function(){h.geoLocation&&h.getCurrent(function(a){null!==a&&m.center(a.lat,a.lng)})}),n=document.getElementById("map-canvas"),o=function(){b.model.busStop?(b.title=c.current.stopNumber+" "+b.model.busStop.id+" "+b.model.busStop.desc,m.createMap(n,b.model.busStop.lat,b.model.busStop.lng),m.addMarker(b.model.busStop.lat,b.model.busStop.lng,a.formatString("{0} {1} {2}",[c.current.stopNumber,b.model.busStop.id,b.model.busStop.desc]))):(b.title=c.current.route+" "+b.model.route.Route,m.createMap(n,h.default.lat,h.default.lng,13)),m.addCircle(h.default.lat,h.default.lng),j=b.model.stopNumber?function(){m.clearBuses(),d.getDepartures([b.model.stopNumber],function(b){b.forEach(function(b){var c=a.formatString("{0} {1} {2} - {3}",[b.Route,b.Terminal,b.RouteDirection,b.Description]);m.addBus(b.VehicleLatitude,b.VehicleLongitude,c)})})}:function(){m.clearBuses(),d.getVehicleLocations(b.model.route.Route,function(a){a.forEach(function(a){var b=a.Route+a.Terminal+" "+a.RouteDirection;m.addBus(a.VehicleLatitude,a.VehicleLongitude,b)})})},j(),f.start(),b.$on("timerBuzz",j),b.$on("$destroy",f.stop)};l&&l.key?g.resolve(l.key,function(c){b.model=c,g.setCurrent(c),a.hasValue(c.stopNumber)&&!a.hasValue(c.busStop)?i.getStop(c.stopNumber,function(a){null!==a&&(c.busStop=a,g.setCurrent(c)),o()}):o()}):(b.model=g.getCurrent(),o())}]),b.controller("faves",["$scope","faves","lang",function(a,b,c){a.lang=c.current,a.model=b,a.list=b.getList(),a.list.forEach(function(a){a.path=a.stopNumber?"stop":"track"})}])}(tct.common,transit),tct.svg={bus:"M285 1542 c-37 -23 -93 -86 -106 -119 -5 -13 -9 -168 -9 -344 l0 -319 -40 0 -40 0 0 100 c0 93 1 100 20 100 19 0 20 7 20 195 l0 195 -55 0 -55 0 0 -195 0 -195 25 0 25 0 0 -110 0 -110 44 0 c37 0 45 -4 50 -22 3 -13 6 -122 6 -243 0 -248 6 -273 73 -332 33 -29 37 -37 37 -83 l0 -50 95 0 95 0 0 40 0 40 275 0 275 0 0 -40 0 -40 95 0 95 0 0 48 c0 43 4 52 41 87 75 72 79 89 79 352 l0 232 53 3 52 3 3 98 c2 89 4 97 22 97 19 0 20 8 20 195 l0 195 -50 0 -50 0 0 -195 c0 -188 1 -195 20 -195 19 0 20 -7 20 -90 l0 -90 -45 0 -45 0 0 323 c0 292 -2 326 -19 362 -22 47 -74 99 -114 114 -18 7 -178 11 -455 11 -396 0 -429 -1 -457 -18z m725 -82 l0 -60 -257 2 -258 3 -3 58 -3 57 261 0 260 0 0 -60z m230 -373 l0 -253 -38 -36 c-41 -40 -116 -77 -202 -99 -76 -19 -434 -19 -510 0 -86 22 -161 59 -202 99 l-38 36 0 253 0 253 495 0 495 0 0 -253z m-20 -562 l0 -55 -475 0 -475 0 0 55 0 55 475 0 475 0 0 -55z m0 -190 l0 -55 -475 0 -475 0 0 55 0 55 475 0 475 0 0 -55z",locate:"M858 994 c-30 -16 -58 -61 -58 -94 0 -29 26 -76 52 -94 12 -9 40 -16 61 -16 55 0 107 52 107 107 0 85 -88 138 -162 97z"},function(a){tct.ws={v:Math.round((new Date).getTime()/1e3/60)-23708152,url:"http://svc.metrotransit.org/NexTrip/{0}?v={1}&format=json&callback={2}",directions:["","SOUTHBOUND","EASTBOUND","WESTBOUND","NORTHBOUND"],getJSON:function(a){var b=document.createElement("script");b.type="text/javascript",b.src=a,document.body.appendChild(b),document.body.removeChild(b)},getRoutes:function(b){this.getRoutesCB=b;var c=a.formatString(this.url,["Routes",this.v++,"tct.ws.getRoutesCB"]);this.getJSON(c)},getDirections:function(b,c){this.getDirectionsCB=c;var d=a.formatString(this.url,["Directions/"+b,this.v++,"tct.ws.getDirectionsCB"]);this.getJSON(d)},getStops:function(b,c,d){this.getStopsCB=d;var e=a.formatString(this.url,["Stops/"+b+"/"+c,this.v++,"tct.ws.getStopsCB"]);this.getJSON(e)},getDepartures:function(b,c){this.getDeparturesCB2=c;var d=a.formatString(this.url,[b.join("/"),this.v++,"tct.ws.getDeparturesCB"]);this.getJSON(d)},getDeparturesCB:function(a){this.convertDates(a),this.getDeparturesCB2(a)},getVehicleLocations:function(b,c){this.getVehicleLocationsCB2=c;var d=a.formatString(this.url,["VehicleLocations/"+b,this.v++,"tct.ws.getVehicleLocationsCB"]);this.getJSON(d)},getVehicleLocationsCB:function(a){a.forEach(function(a){a.RouteDirection=tct.ws.directions[a.Direction]}),this.convertDates(a,"LocationTime"),this.getVehicleLocationsCB2(a)},getRouteDirectionStop:function(a,b,c,d){function i(){e&&h&&f&&(clearTimeout(g),d({route:e,direction:h,stop:f}))}var e,f,g,h={Text:this.directions[b],Value:b.toString()};this.getRoutes(function(b){var c;for(c=0;c<b.length;c++)if(b[c].Route==a)return e=b[c],i(),void 0;e={Route:a},i()}),this.getStops(a,b,function(a){var b;for(b=0;b<a.length;b++)if(a[b].Value==c)return f=a[b],i(),void 0;f={Value:c},i()}),g=setTimeout(d,1e4)},convertDates:function(a,b){b=b||"DepartureTime";var c,d=/\d+/;a.forEach(function(a){c=parseInt(a[b].match(d)),a[b]=new Date(c)})},getBusStop:function(b,c){var d;a.hasValue(a.getStop)?(d=a.getStop(b),c(d)):c(null)}}}(tct.common),function(a){a.directive("tctClock",function(){return{restrict:"E",templateUrl:"partials/clock.html",link:function(a,b){function e(){var a,b=new Date,c=b.getHours();a=12>c?0:1,0==c?c=12:c>12&&(c-=12);var e=Math.floor(c/10),g=c-10*e,h=Math.floor(b.getMinutes()/10),i=b.getMinutes()-10*h,j=Math.floor(b.getSeconds()/10),k=b.getSeconds()-10*j;f(d[1],e,2),f(d[2],g,10),f(d[4],h,6),f(d[5],i,10),f(d[7],j,6),f(d[8],k,10),f(d[9],a,2)}function f(a,b,c){var d,e=a.currentDigit;0==b&&(b=c),(void 0==e||e!=b)&&(a.currentDigit=b,d="pos-"+b,$(a).addClass(d),a.posClass&&$(a).removeClass(a.posClass),a.posClass=d,a.currentDigit==c&&setTimeout(function(){$(a).removeClass(a.posClass)},600))}var c,d=b.find("div");e(),c=setInterval(e,1e3),b.on("$destroy",function(){clearInterval(c)})}}}),a.directive("tctTracker",["faves",function(a){return{restrict:"E",templateUrl:"partials/tracker.html",link:function(b){b.faves=a,b.getColor=tct.common.getColor}}}]),a.directive("tctCountdown",["timer",function(a){return{restrict:"E",templateUrl:"partials/countdown.html",link:function(b,c){c.find("img")[0],b.percent=100,b.interval=a.interval/1e3,b.$on("timerTick",function(){b.$apply(function(){b.percent=a.percent})})}}}]),a.directive("tctLanguage",["lang","$route",function(a,b){return{restrict:"A",link:function(c,d){$(d).click(function(){var c=a.current.name;a.setCurrent("English"==c?"Spanish":"English"),b.reload()})}}}])}(transit);